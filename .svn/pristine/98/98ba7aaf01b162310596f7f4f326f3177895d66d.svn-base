<?phpuse yii\helpers\Html;use yii\bootstrap\Modal;use app\config\Vhelper;use yii\widgets\ActiveForm;use app\services\PurchaseOrderServices;use app\services\SupplierServices;?><style>    h5 {        font-weight: bold;    }    input { padding-left: 5px; }    em {        color: #e4393c;        font-weight: 700;        font-style: normal;    }    s {        color: #e4393c;        font-weight: 700;    }    p {        margin: 0;    }    span.mm {        padding: 0 10px 0 10px;    }    .container-fluid {        border: 1px solid #ccc;    }    .row {        border-top: 1px solid #ccc;        padding: 10px;    }</style><?php ActiveForm::begin(['id' => 'payment-form']); ?><div class="container-fluid">    <h5>订单信息</h5>    <div class="row">        <div class="col-md-12">            <table class="table table-bordered">                <tr>                    <th>采购单号</th>                    <td><?= $orderInfo['pur_number'] ?></td>                    <th>供应商</th>                    <td><?= $orderInfo['supplier_name'] ?></td>                </tr>                <tr>                    <th>结算方式</th>                    <td><?= !empty($orderInfo['account_type']) ? SupplierServices::getSettlementMethod($orderInfo['account_type']) : ''; ?></td>                    <th>支付方式</th>                    <td><?= !empty($orderInfo['pay_type']) ? SupplierServices::getDefaultPaymentMethod($orderInfo['pay_type']) : ''; ?></td>                </tr>                <tr>                    <th>是否含税</th>                    <td><?= !empty($model->is_drawback) && $model->is_drawback == 2 ? '含税' : '不含税'?></td>                    <th>是否加急</th>                    <td><?= !empty($orderInfo['is_expedited'])?PurchaseOrderServices::getIsExpedited($orderInfo['is_expedited']):''; ?></td>                </tr>                <tr>                    <th>1688拍单号</th>                    <td><?= ($model->orderOrders) ? $model->orderOrders->order_number : ''; ?></td>                    <th>账号</th>                    <td><?= ($model->purchaseOrderAccount) ? $model->purchaseOrderAccount->account : ''; ?></td>                </tr>            </table>        </div>    </div>    <h5>商品清单</h5>    <div class="row" style="background-color: #f3f3f3;">        <div class="col-md-2">图片</div>        <div class="col-md-4">产品</div>        <div class="col-md-4">数量</div>        <div class="col-md-2">请款数量</div>    </div>    <?php    $pay_money = 0;    foreach($orderInfo['purchaseOrderItems'] as $k=>$v):        $img = Html::img(Vhelper::downloadImg($v['sku'], $v['product_img'], 2), ['width' => '110px', 'class' => 'img-thumbnail']);        $sku_num = $v['ctq'] ? $v['ctq'] : 0; // 确认数量为空的情况下，以预期数量为准        $pay1 = $v['ruku_num'];        $pay2 = $sku_num-$v['yizhifu_num']-$v['quxiao_num']-$v['weidaohuo_num'];        $pay3 = $sku_num-$v['yizhifu_num']-$v['quxiao_num'];        $pay4 = $sku_num-$v['quxiao_num'];        $arr = [$pay1, $pay1, $pay2, $pay3, $pay4];        $num = $arr[$rpt];        $pay_money += $num*$v['price'];        ?>        <div class="row">            <input type="hidden" name="skus[<?= $k ?>][sku]" value="<?= $v['sku'] ?>">            <input type="hidden" name="skus[<?= $k ?>][price]" value="<?= $v['price'] ?>">            <div class="col-md-2">                <?= $img ?>            </div>            <div class="col-md-4">                <p>SKU：<em><?= $v['sku'] ?></em></p>                <p>单价：<em><?= $v['price'] ?></em></p>                <p>本次采购价：<em><?= $v['price'] ?></em></p>                <p><?= $v['name'] ?></p>            </div>            <div class="col-md-4">                <p>订单数量: <?= $sku_num ?></p>                <p>取消数量: <?= $v['quxiao_num'] ?></p>                <p>收货数量: <?= $v['shouhuo_num'] ?></p>                <p>未到货数量: <?= $v['weidaohuo_num'] ?></p>                <p>入库数量: <?= $v['ruku_num'] ?></p>                <p>不良品数量: <?= $v['nogoods'] ?></p>                <p>已请款数量: <?= $v['yizhifu_num'] ?></p>            </div>            <div class="col-md-2">                <?php if($rpt == 4): ?>                    <input type="text" class="sku_num" name="skus[<?= $k ?>][num]" value="<?= $num ?>" style="width:45px;display:none;" data-price="<?= $v['price'] ?>"  data-pay1="<?= $pay1 ?>" data-pay2="<?= $pay2 ?>" data-pay3="<?= $pay3 ?>" data-pay4="<?= $pay4 ?>" readonly>                <?php else: ?>                    <input type="text" class="sku_num" name="skus[<?= $k ?>][num]" value="<?= $num ?>" style="width:45px;" data-price="<?= $v['price'] ?>"  data-pay1="<?= $pay1 ?>" data-pay2="<?= $pay2 ?>" data-pay3="<?= $pay3 ?>" data-pay4="<?= $pay4 ?>" readonly>                <?php endif; ?>            </div>        </div>    <?php endforeach; ?>    <div class="row" style="background-color: #f3f3f3;">        <div class="col-md-12">            <span class="mm">订单总金额: <em><?= sprintf("%.2f", $orderInfo['sku_count_money']) ?></em></span>            <span class="mm">运费: <em><?= $orderInfo['order_freight'] ?></em></span>            <span class="mm">优惠额: <em><?= $orderInfo['order_discount'] ?></em></span>            <span class="mm">实际金额: <em><?= sprintf("%.2f", $orderInfo['order_real_money']) ?></em></span>        </div>    </div>    <h5>请款方式</h5>    <div class="row">        <div class="col-md-12" style="padding-bottom:10px">            <?php if($rpt == 0): ?>                <p><input type="radio" name="payType" value="1" checked> 按（入库数量）请款</p>                <p><input type="radio" name="payType" value="2"> 按（订单数量-已请款数量-已取消数量-未到货数量）请款</p>                <p><input type="radio" name="payType" value="3"> 按（订单数量-已请款数量-已取消数量）请款</p>                <p><input type="radio" name="payType" value="4"> 按（订单数量-已取消数量）手动请款</p>            <?php elseif($rpt == 1): ?>                <p><input type="hidden" name="payType" value="1"> 按（入库数量）请款</p>            <?php elseif($rpt == 2): ?>                <p><input type="hidden" name="payType" value="2"> 按（订单数量-已请款数量-已取消数量-未到货数量）请款</p>            <?php elseif($rpt == 3): ?>                <p><input type="hidden" name="payType" value="3"> 按（订单数量-已请款数量-已取消数量）请款</p>            <?php elseif($rpt == 4): ?>                <p><input type="hidden" name="payType" value="4"> 按（订单数量-已取消数量）手动请款</p>            <?php endif; ?>        </div>    </div>    <div class="row">        <div class="col-md-6">            <div class="form-group">                <label for="have_paid_money">已申请金额</label>                <input type="text" id="have_paid_money" class="form-control" value="<?= $payInfo['countPayMoney'] ?>" readonly>            </div>            <div class="form-group">                <label for="none_paid_money">剩余金额</label>                <input type="text" id="none_paid_money" class="form-control" value="<?= $orderInfo['order_real_money']-$payInfo['countPayMoney'] ?>" readonly>            </div>            <div class="form-group">                <label for="exampleInputEmail3">请款金额</label>                <input type="text" class="form-control" id="pay_price" name="pay_price" value="" placeholder="最大不能超过订单剩余金额">                <span class="help-block" style="margin-left: 10px;color: #fb0d0d;font-size: 12px;">手动请款时，输入有效。</span>            </div>        </div>        <div class="col-md-6">            <div class="form-group">                <label for="is_freight">运费</label>                <input type="text" id="is_freight" name="is_freight" class="form-control" value="<?= ($payInfo['is_pay_freight'] == 0) ?$orderInfo['order_freight'] : '0' ?>" readonly>            </div>            <div class="form-group">                <label for="is_discount">优惠</label>                <input type="text" id="is_discount" name="is_discount" class="form-control" value="<?= ($payInfo['is_use_discount'] == 0) ?$orderInfo['order_discount'] : '0' ?>" readonly>            </div>            <div class="form-group">                <label for="real_pay_money">实际请款金额</label>                <input type="text" id="real_pay_money" name="real_pay_money" class="form-control" value="<?= sprintf("%.2f", $pay_money); ?>" readonly>            </div>            <div class="form-group">                <label for="exampleInputEmail3">请款备注</label>                <textarea class="form-control" id="create_notice" rows="3" name="create_notice" placeholder="如果不填，默认备注为多次付款"></textarea>            </div>            <span class="btn btn-info" id="btn-submit">申请</span>        </div>    </div></div><input type="hidden" name="rpt" id="rpt" value="<?= $rpt ?>"><input type="hidden" name="pur_number" value="<?= $orderInfo['pur_number'] ?>"><input type="hidden" name="shengyu_money" value="<?= $orderInfo['order_real_money']-$payInfo['countPayMoney'] ?>" id="shengyu_money"><?phpActiveForm::end();?><?php$js = <<<JS$(function() {        // 初始化    $('#real_pay_money').val(countMoney());    var payType=$('#rpt').val();        function floatAdd(arg1,arg2)    {             var r1,r2,m;             try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}             try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}             m=Math.pow(10,Math.max(r1,r2));             return (arg1*m+arg2*m)/m;        }        function floatSub(arg1,arg2)    {            var r1,r2,m,n;            try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}            try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}            m=Math.pow(10,Math.max(r1,r2));            //动态控制精度长度            n=(r1>=r2)?r1:r2;            return ((arg1*m-arg2*m)/m).toFixed(n);        }        function accMul(arg1,arg2)    {        var m=0,s1=arg1.toString(),s2=arg2.toString();        try{m+=s1.split(".")[1].length}catch(e){}        try{m+=s2.split(".")[1].length}catch(e){}        return Number(s1.replace(".",""))*Number(s2.replace(".",""))/Math.pow(10,m);     }        // 金额计算    function countMoney(payType)     {        var total_money = 0;        $('.sku_num').each(function() {            var price = $(this).attr('data-price');            var num = payType ? $(this).attr(payType) : $(this).val();            var money = accMul(price, num);            total_money = floatAdd(total_money, money);            $(this).val(num);        });        // 运费和优惠额        var freight = $('#is_freight').val(),            discount = $('#is_discount').val();        var sub_money = floatSub(freight, discount);        total_money = floatAdd(total_money, sub_money);        return total_money;    }        // 方式切换    $('input[name="payType"]').click(function() {        if($(this).prop('checked')) {            payType = $(this).val();            var attr = '';            switch(payType) {                case '1':                    attr = 'data-pay1';                    $('.sku_num').show();                    break;                case '2':                    attr = 'data-pay2';                    $('.sku_num').show();                    break;                case '3':                    attr = 'data-pay3';                    $('.sku_num').show();                    break;                case '4':                    attr = 'data-pay4';                    $('.sku_num').hide();                    break;            }            $('#real_pay_money').val(countMoney(attr));        }    });        // 提交验证    $('#btn-submit').click(function() {        var pay_price = $('#real_pay_money').val();        if(pay_price <= 0) {            layer.alert('实际请款金额不能小于等于零！');            return false;        }        if(payType == 4) {            var money = $('#pay_price').val();            var shengyu_money = $('#none_paid_money').val();            var reg = /^\d+(\.\d+)?$/;            if(!reg.test(money)) {                layer.alert('请输入合法金额！');                return false;            }            if(parseInt(money) > parseInt(shengyu_money)) {                layer.alert('金额超过上限，无法请款！');                return false;            }            if($('#create_notice').val() == '') {                layer.alert('手动请款时，请务必填写请款备注！');                return false;            }        }        $('#payment-form').submit();    });    });JS;$this->registerJs($js);?>